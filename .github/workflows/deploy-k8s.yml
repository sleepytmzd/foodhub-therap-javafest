name: Deploy to Kubernetes

on:
  workflow_run:
    workflows: ["Build and Push Docker Images"]
    types:
      - completed

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Set up kubectl
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBE_CONFIG_DATA }}" | base64 --decode > $HOME/.kube/config

      - name: Deploy to Kubernetes
        run: |
          IMAGE_TAG=${{ github.sha }}  # workflow_run provides the triggering SHA
          SERVICES=("food-service" "image-service-sb")

          for SERVICE in "${SERVICES[@]}"; do
            kubectl set image deployment.apps/"$SERVICE"-deployment $SERVICE=${{ secrets.DOCKERHUB_USERNAME }}/$SERVICE:$IMAGE_TAG -n default
          done

          for SERVICE in "${SERVICES[@]}"; do
            kubectl rollout status deployment.apps/"$SERVICE"-deployment -n default
          done
